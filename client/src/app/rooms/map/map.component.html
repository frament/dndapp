<div class="top-left">
  <dndapp-map-scenes/>
</div>
<div class="top-center">
  @if (sceneService.currentScene()?.name){
    <button class="title" (click)="sceneService.rightMode.set('scene-options')">{{sceneService.currentScene()?.name}}</button>
  }
</div>
<div class="top-right">

</div>
<div class="bottom-left">
  <dndapp-map-zoom (zoom)="zoom($event)"/>
</div>
<div class="bottom-center">

</div>
<div class="bottom-right">

</div>
<svg
     (pointerdown)="downHandleGrid($event)"
     (pointermove)="moveHandleGrid($event)"
     (wheel)="wheelHandleGrid($event)"
     (click)="clickHandleGrid($event)"
     [attr.viewBox]="'0 0 500 500'"
     #svgGrid>
  <defs>
    <pattern id="smallGrid"
             [attr.width]="gridMiniCubeBimension()" [attr.height]="gridMiniCubeBimension()"
             patternUnits="userSpaceOnUse">
      <path [attr.d]="'M '+gridMiniCubeBimension()+' 0 L 0 0 0 '+gridMiniCubeBimension()" fill="none" stroke="gray" stroke-width="0.5"/>
    </pattern>
    <pattern id="grid"
             [attr.x]="sceneService.currentScene()?.gridDX ?? 0" [attr.y]="sceneService.currentScene()?.gridDY ?? 0"
             [attr.width]="gridCubeDimension()" [attr.height]="gridCubeDimension()"
             patternUnits="userSpaceOnUse">
      <rect [attr.width]="gridCubeDimension()" [attr.height]="gridCubeDimension()" fill="url(#smallGrid)"/>
      <path [attr.d]="'M '+gridCubeDimension()+' 0 L 0 0 0 '+gridCubeDimension()" fill="none" stroke="black" stroke-width="1"/>
    </pattern>
  </defs>
  <image #bgImage x="0" y="0" width="1000" height="1000"/>
  <rect [attr.width]="gridWH().width" [attr.height]="gridWH().height" fill="url(#grid)" />
  <!-- node -->
  <defs>
    <filter id="shadow">
      <feDropShadow dx="3" dy="3" stdDeviation="0" flood-color="rgba(0, 0, 0, .5)" flood-opacity="0.5"/>
    </filter>
    <filter id="liftedShadow">
      <feDropShadow dx="4" dy="4" stdDeviation="0" flood-color="rgba(0, 0, 0, .5)" flood-opacity="0.7"/>
    </filter>
  </defs>
  <g>
    @for(nodeLayer of sceneService.sceneNodes(); track nodeLayer.id){
      <defs>
        @if (sceneService.nodesAvatars.has(nodeLayer.id)){
          <pattern [id]="'avatar_'+nodeLayer.id" x="0%" y="0%" height="100%" width="100%"
                   viewBox="0 0 512 512">
            <rect width="512" height="512" [attr.fill]="nodeLayer.color"/>
            <image [attr.href]="sceneService.nodesAvatars.get(nodeLayer.id)"></image>
          </pattern>
        }
      </defs>
      <rect
        (pointerdown)="downHandleNodeLayer($event, nodeLayer)"
        (click)="clickHandleNodeLayer($event, nodeLayer)"
        class="cursor-pointer"
        [attr.id]="nodeLayer.id"
        [attr.x]="nodeLayer.positionX - (gridCubeDimension() * nodeLayer.scale) / 2"
        [attr.y]="nodeLayer.positionY - (gridCubeDimension() * nodeLayer.scale) / 2"
        [attr.width]="gridCubeDimension() * nodeLayer.scale"
        [attr.height]="gridCubeDimension() * nodeLayer.scale"
        [attr.rx]="nodeLayer.rx"
        [attr.ry]="nodeLayer.ry"
        [attr.stroke]="nodeLayer.color"
        [attr.stroke-width]="2"
        [attr.transform]="nodeLayer.rotate ? 'rotate('+nodeLayer.rotate+'deg)':''"
        [attr.fill]="sceneService.nodesAvatars.has(nodeLayer.id) ? 'url(#avatar_'+nodeLayer.id+')' : nodeLayer.color"
        [attr.filter]="selectedNode()?.id === nodeLayer.id ? 'url(#liftedShadow)' : 'url(#shadow)'">
      </rect>
      <text
        [attr.x]="nodeLayer.positionX - (gridCubeDimension() * nodeLayer.scale) / 2"
        [attr.y]="nodeLayer.positionY - (gridCubeDimension() * nodeLayer.scale) / 2 - 4"
        [attr.width]="gridCubeDimension() * nodeLayer.scale"
        [attr.height]="gridCubeDimension() * nodeLayer.scale"
        [attr.transform]="nodeLayer.rotate ? 'rotate('+nodeLayer.rotate+'deg)':''"
        [attr.fill]="nodeLayer.color"
        [attr.filter]="selectedNode()?.id === nodeLayer.id ? 'url(#liftedShadow)' : 'url(#shadow)'"
      >
        {{nodeLayer.name}}
      </text>
    }
  </g>
</svg>
